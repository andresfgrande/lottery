import { mock } from 'jest-mock-extended';
import { BetsRepository } from './context/bets/infrastructure/betsRepository';
import { UpdateBetService } from './context/bets/services/updateBet.service';
import { v4 as uuidv4 } from 'uuid';
import { Bet } from './context/bets/domain/bet';
import { BetId } from './context/bets/domain/betId';
import { CreationDate } from './context/bets/domain/creationDate';
import { BetNumbers } from './context/bets/domain/betNumbers';
import { Stats } from './context/bets/domain/stats';
import { NotFoundException } from '@nestjs/common';

describe('UpdateBetService', () => {
  const betsRepository = mock<BetsRepository>();
  const updateBetService = new UpdateBetService(betsRepository);

  beforeEach(() => {
    jest.clearAllMocks();
  });

  it('should update a bet', async () => {
    const previousResults = ['12345', '62384', '79236', '79532'];
    const betId = uuidv4();
    const creationDate = '2025-03-27T19:42:23.936Z';
    const updateBetRequest = {
      betId: betId,
      previousResults: previousResults,
    };
    const savedBetPrimitives = {
      betId: betId,
      creationDate: creationDate,
      previousResults: ['12345', '62384'],
      betNumbers: {
        betNumberPairs: [
          {
            pairList: [
              '00',
              '01',
              '02',
              '03',
              '04',
              '05',
              '06',
              '07',
              '08',
              '09',
              '10',
              '11',
              '13',
              '14',
              '15',
              '16',
              '17',
              '18',
              '19',
              '20',
              '21',
              '22',
              '23',
              '24',
              '25',
              '26',
              '27',
              '28',
              '29',
              '30',
              '31',
              '32',
              '33',
              '34',
              '35',
              '36',
              '37',
              '38',
              '39',
              '40',
              '41',
              '42',
              '43',
              '44',
              '45',
              '46',
              '47',
              '48',
              '49',
              '50',
              '51',
              '52',
              '53',
              '54',
              '55',
              '56',
              '57',
              '58',
              '59',
              '60',
              '61',
              '63',
              '64',
              '65',
              '66',
              '67',
              '68',
              '69',
              '70',
              '71',
              '72',
              '73',
              '74',
              '75',
              '76',
              '77',
              '78',
              '79',
              '80',
              '81',
              '82',
              '83',
              '84',
              '85',
              '86',
              '87',
              '88',
              '89',
              '90',
              '91',
              '92',
              '93',
              '94',
              '95',
              '96',
              '97',
              '98',
              '99',
            ],
          },
          {
            pairList: [
              '00',
              '01',
              '02',
              '03',
              '04',
              '05',
              '06',
              '07',
              '08',
              '09',
              '10',
              '11',
              '12',
              '13',
              '14',
              '15',
              '16',
              '17',
              '18',
              '19',
              '20',
              '21',
              '22',
              '24',
              '25',
              '26',
              '27',
              '28',
              '29',
              '30',
              '31',
              '32',
              '33',
              '34',
              '35',
              '36',
              '37',
              '38',
              '39',
              '40',
              '41',
              '42',
              '43',
              '44',
              '45',
              '46',
              '47',
              '48',
              '49',
              '50',
              '51',
              '52',
              '53',
              '54',
              '55',
              '56',
              '57',
              '58',
              '59',
              '60',
              '61',
              '62',
              '63',
              '64',
              '65',
              '66',
              '67',
              '68',
              '69',
              '70',
              '71',
              '72',
              '73',
              '74',
              '75',
              '76',
              '77',
              '78',
              '79',
              '80',
              '81',
              '82',
              '83',
              '84',
              '85',
              '86',
              '87',
              '88',
              '89',
              '90',
              '91',
              '92',
              '93',
              '94',
              '95',
              '96',
              '97',
              '98',
              '99',
            ],
          },
          {
            pairList: [
              '00',
              '01',
              '02',
              '03',
              '04',
              '05',
              '06',
              '07',
              '08',
              '09',
              '10',
              '11',
              '12',
              '13',
              '14',
              '15',
              '16',
              '17',
              '18',
              '19',
              '20',
              '21',
              '22',
              '23',
              '24',
              '25',
              '26',
              '27',
              '28',
              '29',
              '30',
              '31',
              '32',
              '33',
              '35',
              '36',
              '37',
              '39',
              '40',
              '41',
              '42',
              '43',
              '44',
              '45',
              '46',
              '47',
              '48',
              '49',
              '50',
              '51',
              '52',
              '53',
              '54',
              '55',
              '56',
              '57',
              '58',
              '59',
              '60',
              '61',
              '62',
              '63',
              '64',
              '65',
              '66',
              '67',
              '68',
              '69',
              '70',
              '71',
              '72',
              '73',
              '74',
              '75',
              '76',
              '77',
              '78',
              '79',
              '80',
              '81',
              '82',
              '83',
              '84',
              '85',
              '86',
              '87',
              '88',
              '89',
              '90',
              '91',
              '92',
              '93',
              '94',
              '95',
              '96',
              '97',
              '98',
              '99',
            ],
          },
          {
            pairList: [
              '00',
              '01',
              '02',
              '03',
              '04',
              '05',
              '06',
              '07',
              '08',
              '09',
              '10',
              '11',
              '12',
              '13',
              '14',
              '15',
              '16',
              '17',
              '18',
              '19',
              '20',
              '21',
              '22',
              '23',
              '24',
              '25',
              '26',
              '27',
              '28',
              '29',
              '30',
              '31',
              '32',
              '33',
              '34',
              '35',
              '36',
              '37',
              '38',
              '39',
              '40',
              '41',
              '42',
              '43',
              '44',
              '46',
              '47',
              '48',
              '49',
              '50',
              '51',
              '52',
              '53',
              '54',
              '55',
              '56',
              '57',
              '58',
              '59',
              '60',
              '61',
              '62',
              '63',
              '64',
              '65',
              '66',
              '67',
              '68',
              '69',
              '70',
              '71',
              '72',
              '73',
              '74',
              '75',
              '76',
              '77',
              '78',
              '79',
              '80',
              '81',
              '82',
              '83',
              '85',
              '86',
              '87',
              '88',
              '89',
              '90',
              '91',
              '92',
              '93',
              '94',
              '95',
              '96',
              '97',
              '98',
              '99',
            ],
          },
        ],
      },
      stats: {
        statsCollection: [
          {
            numberCounts: [
              {
                numberPair: '12',
                count: 1,
              },
              {
                numberPair: '62',
                count: 1,
              },
            ],
          },
          {
            numberCounts: [
              {
                numberPair: '23',
                count: 2,
              },
            ],
          },
          {
            numberCounts: [
              {
                numberPair: '34',
                count: 1,
              },
              {
                numberPair: '38',
                count: 1,
              },
            ],
          },
          {
            numberCounts: [
              {
                numberPair: '45',
                count: 1,
              },
              {
                numberPair: '84',
                count: 1,
              },
            ],
          },
        ],
      },
    };
    const expectedUpdateBetPrimitives = {
      betId: betId,
      creationDate: creationDate,
      previousResults: previousResults,
      betNumbers: {
        betNumberPairs: [
          {
            pairList: [
              '00',
              '01',
              '02',
              '03',
              '04',
              '05',
              '06',
              '07',
              '08',
              '09',
              '10',
              '11',
              '13',
              '14',
              '15',
              '16',
              '17',
              '18',
              '19',
              '20',
              '21',
              '22',
              '23',
              '24',
              '25',
              '26',
              '27',
              '28',
              '29',
              '30',
              '31',
              '32',
              '33',
              '34',
              '35',
              '36',
              '37',
              '38',
              '39',
              '40',
              '41',
              '42',
              '43',
              '44',
              '45',
              '46',
              '47',
              '48',
              '49',
              '50',
              '51',
              '52',
              '53',
              '54',
              '55',
              '56',
              '57',
              '58',
              '59',
              '60',
              '61',
              '63',
              '64',
              '65',
              '66',
              '67',
              '68',
              '69',
              '70',
              '71',
              '72',
              '73',
              '74',
              '75',
              '76',
              '77',
              '78',
              '80',
              '81',
              '82',
              '83',
              '84',
              '85',
              '86',
              '87',
              '88',
              '89',
              '90',
              '91',
              '92',
              '93',
              '94',
              '95',
              '96',
              '97',
              '98',
              '99',
            ],
          },
          {
            pairList: [
              '00',
              '01',
              '02',
              '03',
              '04',
              '05',
              '06',
              '07',
              '08',
              '09',
              '10',
              '11',
              '12',
              '13',
              '14',
              '15',
              '16',
              '17',
              '18',
              '19',
              '20',
              '21',
              '22',
              '24',
              '25',
              '26',
              '27',
              '28',
              '29',
              '30',
              '31',
              '32',
              '33',
              '34',
              '35',
              '36',
              '37',
              '38',
              '39',
              '40',
              '41',
              '42',
              '43',
              '44',
              '45',
              '46',
              '47',
              '48',
              '49',
              '50',
              '51',
              '52',
              '53',
              '54',
              '55',
              '56',
              '57',
              '58',
              '59',
              '60',
              '61',
              '62',
              '63',
              '64',
              '65',
              '66',
              '67',
              '68',
              '69',
              '70',
              '71',
              '72',
              '73',
              '74',
              '75',
              '76',
              '77',
              '78',
              '79',
              '80',
              '81',
              '82',
              '83',
              '84',
              '85',
              '86',
              '87',
              '88',
              '89',
              '90',
              '91',
              '93',
              '94',
              '96',
              '97',
              '98',
              '99',
            ],
          },
          {
            pairList: [
              '00',
              '01',
              '02',
              '03',
              '04',
              '05',
              '06',
              '07',
              '08',
              '09',
              '10',
              '11',
              '12',
              '13',
              '14',
              '15',
              '16',
              '17',
              '18',
              '19',
              '20',
              '21',
              '22',
              '24',
              '25',
              '26',
              '27',
              '28',
              '29',
              '30',
              '31',
              '32',
              '33',
              '35',
              '36',
              '37',
              '39',
              '40',
              '41',
              '42',
              '43',
              '44',
              '45',
              '46',
              '47',
              '48',
              '49',
              '50',
              '51',
              '52',
              '54',
              '55',
              '56',
              '57',
              '58',
              '59',
              '60',
              '61',
              '62',
              '63',
              '64',
              '65',
              '66',
              '67',
              '68',
              '69',
              '70',
              '71',
              '72',
              '73',
              '74',
              '75',
              '76',
              '77',
              '78',
              '79',
              '80',
              '81',
              '82',
              '83',
              '84',
              '85',
              '86',
              '87',
              '88',
              '89',
              '90',
              '91',
              '92',
              '93',
              '94',
              '95',
              '96',
              '97',
              '98',
              '99',
            ],
          },
          {
            pairList: [
              '00',
              '01',
              '02',
              '03',
              '04',
              '05',
              '06',
              '07',
              '08',
              '09',
              '10',
              '11',
              '12',
              '13',
              '14',
              '15',
              '16',
              '17',
              '18',
              '19',
              '20',
              '21',
              '22',
              '23',
              '24',
              '25',
              '26',
              '27',
              '28',
              '29',
              '30',
              '31',
              '33',
              '34',
              '35',
              '37',
              '38',
              '39',
              '40',
              '41',
              '42',
              '43',
              '44',
              '46',
              '47',
              '48',
              '49',
              '50',
              '51',
              '52',
              '53',
              '54',
              '55',
              '56',
              '57',
              '58',
              '59',
              '60',
              '61',
              '62',
              '63',
              '64',
              '65',
              '66',
              '67',
              '68',
              '69',
              '70',
              '71',
              '72',
              '73',
              '74',
              '75',
              '76',
              '77',
              '78',
              '79',
              '80',
              '81',
              '82',
              '83',
              '85',
              '86',
              '87',
              '88',
              '89',
              '90',
              '91',
              '92',
              '93',
              '94',
              '95',
              '96',
              '97',
              '98',
              '99',
            ],
          },
        ],
      },
      stats: {
        statsCollection: [
          {
            numberCounts: [
              {
                numberPair: '12',
                count: 1,
              },
              {
                numberPair: '62',
                count: 1,
              },
              {
                numberPair: '79',
                count: 2,
              },
            ],
          },
          {
            numberCounts: [
              {
                numberPair: '23',
                count: 2,
              },
              {
                numberPair: '92',
                count: 1,
              },
              {
                numberPair: '95',
                count: 1,
              },
            ],
          },
          {
            numberCounts: [
              {
                numberPair: '23',
                count: 1,
              },
              {
                numberPair: '34',
                count: 1,
              },
              {
                numberPair: '38',
                count: 1,
              },
              {
                numberPair: '53',
                count: 1,
              },
            ],
          },
          {
            numberCounts: [
              {
                numberPair: '32',
                count: 1,
              },
              {
                numberPair: '36',
                count: 1,
              },
              {
                numberPair: '45',
                count: 1,
              },
              {
                numberPair: '84',
                count: 1,
              },
            ],
          },
        ],
      },
    };
    betsRepository.getBet.mockResolvedValue(Bet.fromPrimitives(savedBetPrimitives));

    await updateBetService.execute(updateBetRequest);

    expect(betsRepository.saveBet).toHaveBeenCalledWith(
      Bet.fromPrimitives(expectedUpdateBetPrimitives),
    );
  });

  it('should throw an exception if bet is not found', async () => {
    const previousResults = ['12345', '62384', '79236', '79532'];
    const betId = uuidv4();
    const updateBetRequest = {
      betId: betId,
      previousResults: previousResults,
    };

    betsRepository.getBet.mockResolvedValue(undefined);

    await expect(updateBetService.execute(updateBetRequest)).rejects.toThrow(
      NotFoundException,
    );
  });
});
